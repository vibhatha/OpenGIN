version: '3.8'

services:
  # MongoDB service is removed in production as we use a remote DB

  # Neo4j service is removed in production as we use a remote DB

  # Postgres service is removed in production as we use a remote DB

  core:
    build:
      context: ./opengin/core-api
      dockerfile: docker/Dockerfile.choreo
    container_name: core
    ports:
      - "50051:50051"
    environment:
      # Neo4j Config - Remote DB
      - NEO4J_URI=${NEO4J_URI}
      - NEO4J_USER=${NEO4J_USER}
      - NEO4J_PASSWORD=${NEO4J_PASSWORD}
      # MongoDB Config - Remote DB
      - MONGO_URI=${MONGO_URI}
      - MONGO_DB_NAME=${MONGO_DB_NAME}
      - MONGO_COLLECTION=metadata
      - MONGO_ADMIN_USER=${MONGO_ADMIN_USER}
      - MONGO_ADMIN_PASSWORD=${MONGO_ADMIN_PASSWORD}
      # Postgres Config - Remote DB
      - POSTGRES_HOST=${POSTGRES_HOST}
      - POSTGRES_PORT=${POSTGRES_PORT:-5432}
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${POSTGRES_DB:-postgres}
      - CORE_SERVICE_HOST=0.0.0.0
      - CORE_SERVICE_PORT=50051
    # No depends_on needed as all databases are remote
    networks:
      - ldf-network
    healthcheck:
      test: [ "CMD", "nc", "-zv", "localhost", "50051" ]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 120s

  ingestion:
    build:
      context: ./opengin/ingestion-api
      dockerfile: docker/Dockerfile.choreo
    container_name: ingestion
    ports:
      - "8080:8080"
    networks:
      - ldf-network
    environment:
      # Explicitly set Ballerina Config Var to override image default (core-choreo)
      - BAL_CONFIG_VAR_CORESERVICEURL=http://core:50051
      - CORE_SERVICE_URL=http://core:50051
      - INGESTION_SERVICE_HOST=0.0.0.0
      - INGESTION_SERVICE_PORT=8080
    depends_on:
      core:
        condition: service_healthy
    healthcheck:
      test: [ "CMD", "nc", "-z", "localhost", "8080" ]
      interval: 15s
      timeout: 10s
      retries: 5
      start_period: 120s

  read:
    build:
      context: ./opengin/read-api
      dockerfile: docker/Dockerfile.choreo
    container_name: read
    ports:
      - "8081:8081"
    networks:
      - ldf-network
    environment:
      # Explicitly set Ballerina Config Var to override image default (core-choreo)
      - BAL_CONFIG_VAR_CORESERVICEURL=http://core:50051
      - CORE_SERVICE_URL=http://core:50051
      - READ_SERVICE_HOST=0.0.0.0
      - READ_SERVICE_PORT=8081
    depends_on:
      core:
        condition: service_healthy
    healthcheck:
      test: [ "CMD", "nc", "-zv", "localhost", "8081" ]
      interval: 15s
      timeout: 10s
      retries: 5
      start_period: 120s

networks:
  ldf-network:
    driver: bridge
